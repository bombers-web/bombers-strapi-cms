name: Deploy to AWS Lightsail

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node & Build
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Build Application
        run: |
          npm ci
          npm run build
        env:
          NODE_ENV: production

      - name: Transfer Files to Release Folder
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          source: "./"
          # Deploys to a unique folder per commit
          target: "/opt/strapi/releases/${{ github.sha }}"

      - name: Activate & Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            set -e
            export NODE_ENV=production
            BASE_DIR="/opt/strapi"
            RELEASE_DIR="$BASE_DIR/releases/${{ github.sha }}"
            CURRENT_DIR="/opt/bombers-strapi-cms" # This is your live symlink
            
            # 1. Prepare the new release
            cd $RELEASE_DIR
            npm install --omit=dev --silent
            
            # 2. Swap the symlink (The Atomic Switch)
            ln -sfn $RELEASE_DIR $CURRENT_DIR
            
            # 3. Restart App
            pm2 restart strapi-app || pm2 start ecosystem.config.js
            
            # 4. Health Check
            echo "Checking health..."
            sleep 10
            if ! curl -s --fail http://localhost:1337/_health; then
              echo "Health check failed! Rolling back..."
              exit 1
            fi
            
            # 5. Cleanup: Keep only last 3 releases
            cd $BASE_DIR/releases && ls -t | tail -n +4 | xargs rm -rf --

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            BASE_DIR="/opt/strapi"
            CURRENT_DIR="/opt/bombers-strapi-cms"
            
            # Find the previous successful release (second most recent)
            PREVIOUS_RELEASE=$(ls -dt $BASE_DIR/releases/* | sed -n '2p')
            
            if [ -n "$PREVIOUS_RELEASE" ]; then
              echo "Pointing symlink back to $PREVIOUS_RELEASE"
              ln -sfn $PREVIOUS_RELEASE $CURRENT_DIR
              pm2 restart strapi-app
              echo "Rollback successful."
            else
              echo "No previous release found to rollback to."
              exit 1
            fi